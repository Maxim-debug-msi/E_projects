#include <iostream>
#include <string>
#include <cstdlib>
#include <ctime>
#include <fstream>

struct character
{
    std::string name = "Enemy#";
    int health = 0;
    int armor = 0;
    int damage = 0;
    int coord[2] = {0};
    char sign = 'E';
};

void game_save(character &player, character *enemy, std::ofstream &save)
{
    unsigned int p_name = player.name.length();
    save.write((char*)&p_name, sizeof(p_name));
    save.write(player.name.c_str(), p_name);
    save.write((char*)&player.health, sizeof(player.health));
    save.write((char*)&player.armor, sizeof(player.armor));
    save.write((char*)&player.damage, sizeof(player.damage));
    save.write((char*)&player.coord, sizeof(player.coord));
    save.write((char*)&player.sign, sizeof(player.sign));
    for(int i = 0; i < 5; i++)
    {
        unsigned int e_name = enemy[i].name.length();
        save.write((char*)&e_name, sizeof(e_name));
        save.write(enemy[i].name.c_str(), e_name);
        save.write((char*)&enemy[i].health, sizeof(enemy[i].health));
        save.write((char*)&enemy[i].armor, sizeof(enemy[i].armor));
        save.write((char*)&enemy[i].damage, sizeof(enemy[i].damage));
        save.write((char*)&enemy[i].coord, sizeof(enemy[i].coord));
        save.write((char*)&enemy[i].sign, sizeof(enemy[i].sign));
    }
}

void load_game(character &player, character *enemy, std::ifstream &load)
{
    unsigned int p_name = 0;
    load.read((char*)&p_name, sizeof(p_name));
    player.name.resize(p_name);
    load.read((char*)player.name.c_str(), p_name);
    load.read((char*)&player.health, sizeof(player.health));
    load.read((char*)&player.armor, sizeof(player.armor));
    load.read((char*)&player.damage, sizeof(player.damage));
    load.read((char*)&player.coord, sizeof(player.coord));
    load.read((char*)&player.sign, sizeof(player.sign));
    for(int i = 0; i < 5; i++)
    {
        unsigned int e_name = 0;
        load.read((char*)&e_name, sizeof(e_name));
        enemy[i].name.resize(e_name);
        load.read((char*)enemy[i].name.c_str(), e_name);
        load.read((char*)&enemy[i].health, sizeof(enemy[i].health));
        load.read((char*)&enemy[i].armor, sizeof(enemy[i].armor));
        load.read((char*)&enemy[i].damage, sizeof(enemy[i].damage));
        load.read((char*)&enemy[i].coord, sizeof(enemy[i].coord));
        load.read((char*)&enemy[i].sign, sizeof(enemy[i].sign));
    }
}

void fill_field(char (&field)[40][40])
{
    for(int i = 0; i < 40; i++)//fill of array
    {
        for(int j = 0; j < 40; j++)
        {
            field[i][j] = '.';
        }
    }
}

int main() {
    std::srand(time(nullptr));

    std::string move;
    char field[40][40];

    fill_field(field);

    character enemy[5];
    character player;

    std::cout << "Start new game/download(new/load)?" << std::endl;
    std::cin >> move;

    if(move == "new")
    {
        for (int i = 0; i < 5; i++)//initialization of enemies
        {
            enemy[i].name += std::to_string(i + 1);
            enemy[i].health = rand() % 101 + 50;
            enemy[i].armor = rand() % 51;
            enemy[i].damage = rand() % 16 + 15;
            enemy[i].coord[0] = rand() % 40;
            enemy[i].coord[1] = rand() % 40;
            field[enemy[i].coord[0]][enemy[i].coord[1]] = enemy[i].sign;
        }

        std::cout << "Character creator." << std::endl;

        std::cout << "Enter name of character:" << std::endl;
        std::cin >> player.name;

        std::cout << "Enter the level health:" << std::endl;
        std::cin >> player.health;

        std::cout << "Enter the level armor:" << std::endl;
        std::cin >> player.armor;

        std::cout << "Enter the level damage:" << std::endl;
        std::cin >> player.damage;

        player.sign = 'P';
        player.coord[0] = rand() % 40;
        player.coord[1] = rand() % 40;
        field[player.coord[0]][player.coord[1]] = player.sign;
    }
    else
    {
        fill_field(field);
        std::ifstream load;
        load.open("C:\\E_files\\save.bin", std::ios::binary);
        if(!load.is_open())
        {
            std::cout << "Error load." << std::endl;
            return 1;
        }
        load_game(player, enemy, load);
        load.close();
    }
    while(enemy[0].health + enemy[1].health + enemy[2].health + enemy[3].health + enemy[4].health > 0
            || player.health > 0)
    {
        std::cout << "Enter you movement(left, right, top, bottom, save, load):" << std::endl;
        std::cin >> move;

        int p_1 = player.coord[0];
        int p_2 = player.coord[1];
        bool cor_in;//correct input
        bool p_attack = false;

        do { // check correct input
            cor_in = true;
            if (move == "left") {
                player.coord[1] -= 1;
            } else if (move == "right") {
                player.coord[1] += 1;
            } else if (move == "top") {
                player.coord[0] -= 1;
            } else if (move == "bottom") {
                player.coord[0] += 1;
            }
            else if(move == "save")
            {
                std::ofstream save;
                save.open("C:\\E_files\\save.bin", std::ios::binary);
                if(save.is_open())
                {
                    game_save(player, enemy, save);
                    save.close();
                }
                else
                {
                    std::cout << "Failed to save game." << std::endl;
                    cor_in = false;
                }
            }
            else if(move == "load")
            {
                fill_field(field);
                std::ifstream load;
                load.open("C:\\E_files\\save.bin", std::ios::binary);
                if(load.is_open())
                {
                    load_game(player, enemy, load);
                    load.close();
                }
                else
                {
                    std::cout << "Failed to load game." << std::endl;
                    cor_in = false;
                }
            }
            else if(player.coord[0] > 39 || player.coord[0] < 0 || player.coord[1] > 39 || player.coord[1] < 0)
            {
                std::cout << "Coordinates are out of field. Try again." << std::endl;
                player.coord[0] = p_1;
                player.coord[1] = p_2;
                cor_in = false;
            }
            else if(field[player.coord[0]][player.coord[1]] == 'E')
            {
                player.coord[0] = p_1;
                player.coord[1] = p_2;
                p_attack = true;
            }
            else
            {
                std::cout << "Incorrect command. Try again." << std::endl;
                cor_in = false;
            }
            if(!p_attack && cor_in)
            {
                field[p_1][p_2] = '.';
                field[player.coord[0]][player.coord[1]] = player.sign;
            }
        }while(!cor_in);

        for(int i = 0; i < 5 && p_attack; i++)//attack of player
        {

            if(player.coord[0] == enemy[i].coord[0] && player.coord[1] == enemy[i].coord[1])
            {
                std::cout << player.name << " attack " << enemy[i].name << std::endl;

                p_attack = false;

                if(enemy[i].armor < player.damage)
                {
                    enemy[i].health -= player.damage - enemy[i].armor;
                    enemy[i].armor = 0;
                }
                else
                {
                    enemy[i].armor -= player.damage;
                }
            }
        }

        for(int i = 0; i < 5; i++) //movement and attack of enemy
        {
            if(enemy[i].health > 0)
            {
                int e_1 = enemy[i].coord[0];
                int e_2 = enemy[i].coord[1];
                int x = rand() % 2;
                enemy[i].coord[x] += (rand() % 2 * 2) - 1;

                if (enemy[i].coord[x] > 39 || enemy[i].coord[x] < 0)
                {
                    enemy[i].coord[0] = e_1;
                    enemy[i].coord[1] = e_2;
                }
                else if (enemy[i].coord[0] == player.coord[0] && enemy[i].coord[1] == player.coord[1])
                {
                    std::cout << enemy[i].name << " attack " << player.name << std::endl;

                    if (player.armor < enemy[i].damage)
                    {
                        player.health -= enemy[i].damage - player.armor;
                        player.armor = 0;
                    }
                    else
                    {
                        player.armor -= enemy[i].damage;
                    }
                    enemy[i].coord[0] = e_1;
                    enemy[i].coord[1] = e_2;
                }
                else
                {
                    field[e_1][e_2] = '.';
                    field[enemy[i].coord[0]][enemy[i].coord[1]] = enemy[i].sign;
                }
            }
            else
            {
                field[enemy[i].coord[0]][enemy[i].coord[1]] = '.';
            }
        }

        for (int i = 0; i < 40; i++) {//drawing a field
            for (int j = 0; j < 40; j++) {
                std::cout << field[i][j] << " ";
            }
            std::cout << std::endl;
        }
        for (int i = 0; i < 5; i++) {// stats
            std::cout << enemy[i].name << std::endl;
            std::cout << "Health: " << enemy[i].health << std::endl;
            std::cout << "Armor: " << enemy[i].armor << std::endl;
            std::cout << "Damage: " << enemy[i].damage << std::endl;
            std::cout << "Coord: " << enemy[i].coord[0] << ";" << enemy[i].coord[1] << std::endl;
            std::cout << "~~~~~~~~~~~~~~~~~~" << std::endl;
        }
        std::cout << player.name << std::endl;
        std::cout << "Health: " << player.health << std::endl;
        std::cout << "Armor: " << player.armor << std::endl;
        std::cout << "Damage: " << player.damage << std::endl;
        std::cout << "Coord: " <<player.coord[0] << ";" << player.coord[1] << std::endl;
        std::cout << "~~~~~~~~~~~~~~~~~~" << std::endl;
    }
    if(player.health <= 0)
    {
        std::cout << "You lose!" << std::endl;
    }
    else
    {
        std::cout << "You win!" << std::endl;
    }
    return 0;
}
